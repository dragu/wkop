<?php

namespace Wkop;

use GuzzleHttp\Psr7\Response;

class Client
{
    /**
     * Array of rights.
     *
     * @var array
     */
    private $rights;

    /**
    * Application account key.
    *
    * @var string $appKey
    */
    private $appKey;

    /**
     * User key.
     * It is returned by server when singing in.
     *
     * @var string $userKey
     */
    private $userKey;

    /**
     * Secret key.
     *
     * @var string $secretKey
     */
    private $secretKey;

    /**
     * @var string
     */
    private $userLogin = null;

    /**
     * Key generated by user for specific application.
     *
     * @var string
     */
    private $userAccountKey = null;

    /**
     * Http client used by this class.
     *
     * @var \GuzzleHttp\Client $httpClient
     */
    private $httpClient;

    /**
     * Signer class.
     *
     * @var Signer $signer
     */
    private $signer;

    /**
     * @param $appKey
     * @param $secretKey
     * @param $httpClient
     */
    public function __construct($appKey, $secretKey, $httpClient)
    {
        $this->appKey = $appKey;
        $this->secretKey = $secretKey;

        $this->httpClient = $httpClient;
    }

    /**
     * @param Signer $signer
     */
    public function setSigner(Signer $signer)
    {
        $this->signer = $signer;
    }

    /**
     * @param $userLogin
     * @param $userAccountKey
     */
    public function setUserCredentials($userLogin, $userAccountKey)
    {
        $this->userLogin = $userLogin;
        $this->userAccountKey = $userAccountKey;
    }

    /**
     * Perform login action.
     * Return boolean representation of failure or success
     *
     * @return bool
     * @throws Exceptions\UrlMissingException
     */
    public function logIn()
    {
        if (is_null($this->userLogin) || is_null($this->userAccountKey)) {
            return false;
        }

        $url = 'https://a.wykop.pl/user/login/appkey,' . $this->appKey;
        $postData = [
            'login'         => $this->userLogin,
            'accountkey'    => $this->userAccountKey,
        ];

        $this->signer
            ->setUrl($url)
            ->setPostData($postData);

        $signingKey = $this->signer->getSigningKey();

        $response = $this->httpClient
            ->post(
                $url,
                [
                    'headers' => [
                        'apisign' => $signingKey,
                    ],
                    'form_params' => $postData
                ]
            );

        if ($response->getStatusCode() != 200) {
            $this->userKey = null;
            return false;
        }

        $json = $this->decodeJson($response);

        if (! isset($json['userkey'])) {
            // Can't really tell what kind of error is this.
            $this->userKey = null;

            return false;
        }

        $this->userKey = $json['userkey'];

        return true;
    }

    /**
     * @return bool
     */
    public function getLoginStatus()
    {
        return ! is_null($this->userKey);
    }

    /**
     * Get resources from API.
     *
     * @param $resource
     * @param $params
     * @return mixed
     */
    public function get($resource, $params = [], $methodParams = [])
    {
        $url = $this->prepareUrl($resource, $params, $methodParams);

        $this->signer->setUrl($url);
        $signingKey = $this->signer->getSigningKey();


        $response = $this->httpClient
            ->get(
                $url,
                [
                    'headers' => [
                        'apisign' => $signingKey,
                    ],
                ]
            );

        return $this->decodeJson($response);
    }

    /**
     * Post data
     *
     * @param $resource
     * @param array $params
     * @param array $methodParams
     * @param array $postData
     * @return mixed
     * @throws Exceptions\UrlMissingException
     */
    public function post($resource, $params = [], $methodParams = [], $postData = [])
    {
        $url = $this->prepareUrl($resource, $params, $methodParams);

        $this->signer->setUrl($url)->setPostData($postData);

        $signingKey = $this->signer->getSigningKey();

        $response = $this->httpClient
            ->post(
                $url,
                [
                    'headers' => [
                        'apisign' => $signingKey
                    ],
                    'form_params' => $postData
                ]
            );

        return $this->decodeJson($response);
    }

    /**
     * Return comma separated values.
     *
     * @param $methodParams
     * @return string
     */
    private function implodeMethodParams($methodParams)
    {
        $result = ",";
        foreach ($methodParams as $key => $value) {
            $result .= $key . ',' . $value;
        }

        return $result;
    }

    /**
     * @param $resource
     * @param $params
     * @param $methodParams
     * @return string
     */
    private function prepareUrl($resource, $params, $methodParams)
    {
        $url = 'https://a.wykop.pl/' . $resource . '/' . implode('/', $params)
            . '/appkey,' . $this->appKey . ',userkey,' . $this->userKey . $this->implodeMethodParams($methodParams);
        return $url;
    }

    /**
     * @param Response $response
     * @return array
     */
    private function decodeJson(Response $response)
    {
        return json_decode($response->getBody(), true);
    }
}
